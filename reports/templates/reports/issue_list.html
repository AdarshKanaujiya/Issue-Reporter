<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reported Issues</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">

    <!-- Leaflet.js for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- <style>
        #map { height: 400px; width: 100%; }
        .container { margin: 20px; }
    </style> -->
    <style>
      body {
          font-family: 'Roboto', sans-serif;
          background-color: #f4f4f9;
          margin: 0;
          padding: 20px;
      }
      .container {
          max-width: 1200px;
          margin: auto;
          padding: 20px;
      }
      h2 {
          color: #003366;
          text-align: center;
          background-color: #e0e0e0;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      .admin-login {
          position: absolute;
          top: 20px;
          right: 20px;
          background-color: #4CAF50;
          color: white;
          padding: 10px 15px;
          border-radius: 5px;
          text-align: center;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .admin-login a {
          color: white;
          text-decoration: none;
      }
      .admin-login a:hover {
          text-decoration: underline;
      }
      #map {
          height: 500px;
          width: 100%;
          margin-top: 20px;
          border-radius: 5px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
          position: relative; /* Make the map container relative for positioning the button */
      }
      .button-container {
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-top: 20px;
      }
      .button {
          background-color: #003366;
          color: white;
          padding: 20px 0;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          text-align: center;
          width: 100%;
          font-size: 20px;
          margin: 10px 0;
          transition: background-color 0.3s;
      }
      .button:hover {
          background-color: #002244;
      }
      ul {
          list-style-type: none;
          padding: 0;
      }
      li {
          background: #fff;
          margin: 10px 0;
          padding: 15px;
          border-radius: 5px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      a {
          text-decoration: none;
          color: #003366;
      }
      a:hover {
          text-decoration: underline;
      }
      .recenter-button {
          position: absolute; /* Position it absolutely within the map container */
          bottom: 20px; /* Distance from the bottom */
          right: 20px; /* Distance from the right */
          background-color: #fff;
          border: 2px solid #003366;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
          transition: background-color 0.3s;
          z-index: 1000; /* Ensure it appears in front of the map */
      }
      .recenter-button:hover {
          background-color: #e0e0e0;
      }
      .recenter-button span {
          font-size: 20px; /* Adjust size for the emoji */
      }
  </style>
</head>
<body>

    <!-- Admin Login Button -->
    <div class="login">
      {% if user.is_authenticated %}
      <a href="{% url 'user_issues' %}">My Reported Issues</a>
      <span>/</span>
      <a href="{% url 'logout' %}">Logout</a>
  {% else %}
      <a href="{% url 'login' %}">Login</a>
      <!-- <a href="{% url 'register' %}">Register</a> -->
  {% endif %}
    </div>

    <div class="container">
      <h2>Reported Issues</h2>
      
      <div id="map">
          <div class="recenter-button " onclick="recenterMap()">
              <span>ðŸ”„</span>
          </div>
      </div> <!-- Map placeholder -->

      <div class="button-container">
          <button class="button" onclick="location.href='/report/'">Report an Issue</button>
          <button class="button" onclick="location.href='/view_issues/'">View Issues</button>
          <button class="button" onclick="location.href='/search_issue/'">Search Issues</button>
      </div>
  </div>
  
    <!-- Navigation Links -->
    <!-- <nav>
        <a href="{% url 'report_issue' %}">Report an Issue</a>
        <a href="{% url 'search_issue' %}">Search an Issue</a>
        <a href="{% url 'admin_login' %}">Admin Login</a>

        
    </nav> -->

    
    <!-- Link to Report an Issue Form -->
    <!-- <a href="{% url 'report_issue' %}">Report an Issue</a>
    <a href="{% url 'admin_login' %}">Admin Login</a>
    <a href="{% url 'search_issue' %}">Search an Issue</a> -->

    <!-- Map Container -->
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Pass issue data safely as JSON -->
    <script id="issue-data" type="application/json">{{ issues_json|safe }}</script>

    <script>
        function initMap() {
            var map = L.map('map').setView([20, 77], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            var issues = JSON.parse(document.getElementById("issue-data").textContent);
            console.log(issues);

            if (issues.length > 0) {
                var bounds = L.latLngBounds();

                issues.forEach(function(issue) {
                    if (!issue.lat && !issue.lng && issue.location) {
                        var locationParts = issue.location.split(', ');
                        if (locationParts.length === 2) {
                            issue.lat = parseFloat(locationParts[0]);
                            issue.lng = parseFloat(locationParts[1]);
                        }
                    }

                    if (issue.lat && issue.lng) {
                        var marker = L.marker([issue.lat, issue.lng])
                            .addTo(map)
                            .bindPopup('<b>' + issue.title + '</b><br>' + 
                                       'Status: ' + issue.status + '<br>' + 
                                       'Location: ' + issue.location + '<br>' +
                                       'Description: ' + issue.description);

                        bounds.extend([issue.lat, issue.lng]);
                    }
                });

                if (bounds.isValid()) {
                    map.fitBounds(bounds);
                }
            }

            // Function to recenter the map
            window.recenterMap = function() {
                map.setView([20, 77], 5);
            };
        }

        document.addEventListener("DOMContentLoaded", initMap);
    </script>

</body>
</html>
